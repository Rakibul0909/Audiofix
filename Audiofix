#!/bin/sh
# Audiofix - start/stop a simple TCP audio module for PulseAudio
# Usage: ./Audiofix start|stop

# ----------- Color Codes -----------
RED="\033[31m"
GREEN="\033[32m"
YELLOW="\033[33m"
CYAN="\033[36m"
MAGENTA="\033[35m"
BOLD="\033[1m"
RESET="\033[0m"

sleep 1

# ----------- Banner -----------
echo ""
echo  "${CYAN}${BOLD}<==============================================>${RESET}"
echo  "${MAGENTA}${BOLD}            Audiofix - TCP Audio Module       ${RESET}"
echo  "${GREEN}${BOLD}               Created by </> Rakibul         ${RESET}"
echo  "${CYAN}${BOLD}<==============================================>${RESET}"
echo ""

# ----------- Core Settings -----------
MODULE_NAME="module-simple-protocol-tcp"
MODULE_ARGS="rate=48000 format=s16le channels=2 source=auto_null.monitor record=true port=1996"

get_module_id() {
  pactl list short modules 2>/dev/null | grep "$MODULE_NAME" | awk '{print $1}' | head -n1
}

ensure_pulseaudio() {
  if ! pulseaudio --check 2>/dev/null; then
    echo "${YELLOW}[!] Starting PulseAudio daemon...${RESET}"
    pulseaudio --start >/dev/null 2>&1
    sleep 1
  fi

  # If still not connectable, force restart
  if ! pactl info >/dev/null 2>&1; then
    echo "${YELLOW}[!] Restarting PulseAudio (fixing connection)...${RESET}"
    pulseaudio -k >/dev/null 2>&1
    sleep 1
    pulseaudio --start >/dev/null 2>&1
    sleep 1
  fi
}

case "$1" in
  start)
    ensure_pulseaudio

    EXISTING=$(get_module_id)
    if [ -n "$EXISTING" ]; then
      pactl unload-module "$EXISTING" >/dev/null 2>&1
      echo "${YELLOW}[!] Previous audio TCP module (id $EXISTING) unloaded.${RESET}"
    fi

    NEW_ID=$(pactl load-module "$MODULE_NAME" $MODULE_ARGS 2>/dev/null)
    if printf '%s' "$NEW_ID" | grep -qE '^[0-9]+$'; then
      echo "${GREEN}${BOLD}[✓] Audio TCP module loaded successfully (id $NEW_ID)${RESET}"
    else
      echo "${RED}${BOLD}[×] Failed to load audio TCP module${RESET}"
      echo "${YELLOW}[i] Attempting to load TCP protocol module (backup)...${RESET}"
      pactl load-module module-native-protocol-tcp auth-anonymous=1 >/dev/null 2>&1
      echo "${GREEN}[✓] TCP connection enabled for PulseAudio${RESET}"
      echo "${YELLOW}Try running: ./Audiofix start again${RESET}"
      exit 1
    fi
    ;;
  stop)
    MODULE_ID=$(get_module_id)
    if [ -n "$MODULE_ID" ]; then
      pactl unload-module "$MODULE_ID" >/dev/null 2>&1 && \
      echo "${GREEN}${BOLD}[✓] Audio TCP module unloaded (id $MODULE_ID)${RESET}" || \
      echo "${RED}${BOLD}[×] Failed to unload module id $MODULE_ID${RESET}"
    else
      echo "${YELLOW}${BOLD}[!] No audio TCP module found${RESET}"
    fi
    ;;
  *)
    echo "${RED}${BOLD}[×] Usage: $0 start|stop${RESET}" >&2
    exit 2
    ;;
esac

echo ""
